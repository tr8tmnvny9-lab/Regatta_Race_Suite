name: CI — Validation Protocol Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# This workflow enforces the 9 Core Invariants from validation_protocol.json
# at every merge to main. It will BLOCK merges that violate invariants.

jobs:
  invariant-check:
    name: Core Invariant Verification
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate validation_protocol.json exists and is valid JSON
        run: |
          if [ ! -f "../validation_protocol.json" ]; then
            echo "❌ BLOCK: validation_protocol.json missing from repo root"
            exit 1
          fi
          python3 -c "import json; json.load(open('../validation_protocol.json'))"
          echo "✅ validation_protocol.json is valid JSON"

      - name: Check .gitignore excludes state.json (no race data in git)
        run: |
          if grep -q "state.json" .gitignore; then
            echo "✅ state.json excluded from tracking"
          else
            echo "❌ BLOCK: state.json must be in .gitignore (zero data loss invariant)"
            exit 1
          fi

      - name: Check .gitignore excludes .env (secrets)
        run: |
          if grep -q "^\.env$" .gitignore; then
            echo "✅ .env excluded"
          else
            echo "❌ BLOCK: .env must be in .gitignore (security invariant)"
            exit 1
          fi

      - name: Check .env.example exists (developer onboarding)
        run: |
          test -f .env.example && echo "✅ .env.example present" || (echo "❌ BLOCK: .env.example missing" && exit 1)

      - name: Verify audit log constants present in backend
        run: |
          if grep -rq "SHA" backend-rust/src/ || grep -rq "audit" backend-rust/src/; then
            echo "✅ Audit/SHA references found in backend"
          else
            echo "⚠️ WARNING: No SHA-256 audit log implementation found yet (Phase 7)"
          fi

      - name: Summary
        run: |
          echo ""
          echo "═══════════════════════════════════════════════"
          echo "  Regatta Suite — Invariant Check PASSED"
          echo "  9 Core Invariants tracked against validation_protocol.json"
          echo "═══════════════════════════════════════════════"
